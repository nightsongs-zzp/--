<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“ˆåŸºç±³äº’åŠ¨éŸ³ä¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .title {
            position: absolute;
            top: 30px;
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            background: linear-gradient(90deg, #ff6ec7, #7873f5, #4fc3f7);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px rgba(255, 110, 199, 0.5);
            animation: pulse 2s infinite, gradientShift 5s infinite;
            z-index: 10;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .canvas-container {
            position: relative;
            width: 90%;
            max-width: 900px;
            height: 70vh;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        canvas {
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .controls {
            position: absolute;
            bottom: 30px;
            display: flex;
            gap: 20px;
            z-index: 10;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90%;
        }

        button {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 110, 199, 0.3);
        }

        button.active {
            background: rgba(255, 110, 199, 0.3);
            border-color: rgba(255, 110, 199, 0.5);
        }

        .particle {
            position: absolute;
            pointer-events: none;
            opacity: 0;
            border-radius: 50%;
        }

        .info {
            position: absolute;
            top: 80px;
            text-align: center;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            z-index: 10;
        }

        .instruction {
            position: absolute;
            bottom: 100px;
            text-align: center;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            z-index: 10;
        }

        .bgm-control {
            position: absolute;
            top: 130px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 20px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
        }

        .bgm-control label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .volume-slider {
            width: 100px;
            height: 5px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #ff6ec7;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #ff6ec7;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .visualizer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 0 10px;
            pointer-events: none;
            z-index: 5;
        }

        .visualizer-bar {
            width: 4%;
            background: linear-gradient(to top, rgba(255, 110, 199, 0.7), rgba(120, 115, 245, 0.7));
            border-radius: 2px 2px 0 0;
            transition: height 0.2s ease;
        }

        .hakimi-character {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255, 110, 199, 0.8) 0%, rgba(120, 115, 245, 0.6) 70%, transparent 100%);
            border-radius: 50%;
            animation: float 4s ease-in-out infinite;
            z-index: 6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .region-indicator {
            position: absolute;
            width: 100%;
            height: 33.33%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.3);
            font-weight: bold;
            text-transform: uppercase;
            pointer-events: none;
            letter-spacing: 2px;
            transition: all 0.3s ease;
        }

        .region-indicator.top {
            top: 0;
            color: rgba(255, 110, 199, 0.3);
        }

        .region-indicator.middle {
            top: 33.33%;
            color: rgba(120, 115, 245, 0.3);
        }

        .region-indicator.bottom {
            top: 66.66%;
            color: rgba(79, 195, 247, 0.3);
        }
    </style>
</head>
<body>
    <h1 class="title">å“ˆåŸºç±³äº’åŠ¨éŸ³ä¹</h1>
    <p class="info">ç‚¹å‡»ç”»å¸ƒåˆ›ä½œä½ çš„éŸ³ä¹</p>

    <div class="bgm-control">
        <label>èƒŒæ™¯éŸ³ä¹</label>
        <button id="bgmToggle">ğŸ”‡</button>
        <input type="range" class="volume-slider" id="bgmVolume" min="0" max="100" value="30">
    </div>

    <div class="canvas-container">
        <canvas id="musicCanvas"></canvas>
        <div class="region-indicator top">å“ˆ</div>
        <div class="region-indicator middle">åŸº</div>
        <div class="region-indicator bottom">ç±³</div>
        <div class="visualizer" id="visualizer"></div>
        <div class="hakimi-character" id="hakimiCharacter">ğŸ±</div>
    </div>

    <p class="instruction">ç‚¹å‡»ä¸åŒåŒºåŸŸè§¦å‘ä¸åŒéŸ³æ•ˆ â€¢ æŒ‰ä½é¼ æ ‡æ‹–åŠ¨åˆ›é€ è¿ç»­èŠ‚å¥</p>
    <div class="controls">
        <button id="clearBtn">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
        <button id="recordBtn">âºï¸ å½•åˆ¶éŸ³ä¹</button>
        <button id="playbackBtn">â–¶ï¸ æ’­æ”¾å½•åˆ¶</button>
        <button id="randomBtn">ğŸ² éšæœºèŠ‚å¥</button>
        <button id="autoBtn">ğŸ¤– è‡ªåŠ¨æ¼”å¥</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('musicCanvas');
            const ctx = canvas.getContext('2d');
            const clearBtn = document.getElementById('clearBtn');
            const recordBtn = document.getElementById('recordBtn');
            const playbackBtn = document.getElementById('playbackBtn');
            const bgmToggle = document.getElementById('bgmToggle');
            const bgmVolume = document.getElementById('bgmVolume');
            const randomBtn = document.getElementById('randomBtn');
            const autoBtn = document.getElementById('autoBtn');
            const visualizer = document.getElementById('visualizer');
            const hakimiCharacter = document.getElementById('hakimiCharacter');

            // åˆ›å»ºå¯è§†åŒ–æ¡
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.height = '5px';
                visualizer.appendChild(bar);
            }

            // èƒŒæ™¯éŸ³ä¹è®¾ç½®
            let bgmEnabled = false;
            let bgmGainNode = null;
            let bgmOscillator = null;

            // åˆ›å»ºèƒŒæ™¯éŸ³ä¹
            function createBGM() {
                if (!audioContext) return;

                // å¦‚æœå·²æœ‰BGMï¼Œå…ˆåœæ­¢
                if (bgmOscillator) {
                    bgmOscillator.stop();
                    bgmOscillator = null;
                }

                if (!bgmEnabled) return;

                // åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹
                bgmOscillator = audioContext.createOscillator();
                bgmGainNode = audioContext.createGain();

                // è®¾ç½®éŸ³é‡
                const volume = bgmVolume.value / 100;
                bgmGainNode.gain.value = volume * 0.1; // é™ä½èƒŒæ™¯éŸ³ä¹éŸ³é‡

                // è¿æ¥èŠ‚ç‚¹
                bgmOscillator.connect(bgmGainNode);
                bgmGainNode.connect(audioContext.destination);

                // è®¾ç½®æ³¢å½¢ç±»å‹å’Œé¢‘ç‡
                bgmOscillator.type = 'sine';
                bgmOscillator.frequency.value = 220; // A3éŸ³ç¬¦

                // åˆ›å»ºç®€å•çš„æ—‹å¾‹
                const now = audioContext.currentTime;
                const melody = [
                    { time: now, freq: 220, duration: 0.5 },  // A3
                    { time: now + 0.5, freq: 246.94, duration: 0.5 },  // B3
                    { time: now + 1, freq: 261.63, duration: 0.5 },  // C4
                    { time: now + 1.5, freq: 293.66, duration: 0.5 },  // D4
                    { time: now + 2, freq: 329.63, duration: 1 },  // E4
                    { time: now + 3, freq: 293.66, duration: 0.5 },  // D4
                    { time: now + 3.5, freq: 261.63, duration: 0.5 },  // C4
                    { time: now + 4, freq: 246.94, duration: 1 },  // B3
                ];

                // å¼€å§‹æ’­æ”¾
                bgmOscillator.start();

                // æ’­æ”¾æ—‹å¾‹
                melody.forEach(note => {
                    bgmOscillator.frequency.setValueAtTime(note.freq, note.time);
                });

                // å¾ªç¯æ’­æ”¾
                setTimeout(() => {
                    if (bgmEnabled) {
                        createBGM();
                    }
                }, 5000);
            }

            // BGMæ§åˆ¶
            bgmToggle.addEventListener('click', () => {
                bgmEnabled = !bgmEnabled;
                bgmToggle.textContent = bgmEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
                bgmToggle.classList.toggle('active', bgmEnabled);

                if (bgmEnabled) {
                    createBGM();
                } else if (bgmOscillator) {
                    bgmOscillator.stop();
                    bgmOscillator = null;
                }
            });

            bgmVolume.addEventListener('input', () => {
                if (bgmGainNode) {
                    const volume = bgmVolume.value / 100;
                    bgmGainNode.gain.value = volume * 0.1;
                }
            });

            // éšæœºèŠ‚å¥åŠŸèƒ½
            let randomInterval = null;

            function createRandomRhythm() {
                const regions = ['ha', 'ji', 'mi'];
                const colors = ['#ff6ec7', '#7873f5', '#4fc3f7'];

                // éšæœºé€‰æ‹©åŒºåŸŸå’Œä½ç½®
                const regionIndex = Math.floor(Math.random() * regions.length);
                const region = regions[regionIndex];
                const color = colors[regionIndex];

                // æ ¹æ®åŒºåŸŸç¡®å®šYåæ ‡
                let y;
                if (region === 'ha') {
                    y = Math.random() * (canvas.height / 3);
                } else if (region === 'ji') {
                    y = canvas.height / 3 + Math.random() * (canvas.height / 3);
                } else {
                    y = (canvas.height * 2) / 3 + Math.random() * (canvas.height / 3);
                }

                // éšæœºXåæ ‡
                const x = Math.random() * canvas.width;

                // æ’­æ”¾å£°éŸ³å’Œåˆ›å»ºè§†è§‰æ•ˆæœ
                playSound(region);
                circles.push(new Circle(x, y, color, region));
                createParticles(x, y, color);

                // ç§»åŠ¨å“ˆåŸºç±³è§’è‰²
                moveHakimiCharacter(x, y);
            }

            randomBtn.addEventListener('click', () => {
                if (randomInterval) {
                    clearInterval(randomInterval);
                    randomInterval = null;
                    randomBtn.classList.remove('active');
                    randomBtn.textContent = 'ğŸ² éšæœºèŠ‚å¥';
                } else {
                    randomInterval = setInterval(createRandomRhythm, 500);
                    randomBtn.classList.add('active');
                    randomBtn.textContent = 'â¹ï¸ åœæ­¢éšæœº';
                }
            });

            // è‡ªåŠ¨æ¼”å¥åŠŸèƒ½
            let autoInterval = null;
            let autoPattern = 0;

            function createAutoPattern() {
                // é¢„å®šä¹‰çš„å‡ ç§æ¨¡å¼
                const patterns = [
                    // æ¨¡å¼1ï¼šä»ä¸Šåˆ°ä¸‹
                    () => {
                        const sequence = [
                            { x: canvas.width / 2, y: canvas.height / 6, type: 'ha', color: '#ff6ec7' },
                            { x: canvas.width / 2, y: canvas.height / 2, type: 'ji', color: '#7873f5' },
                            { x: canvas.width / 2, y: canvas.height * 5 / 6, type: 'mi', color: '#4fc3f7' },
                        ];
                        return sequence;
                    },
                    // æ¨¡å¼2ï¼šä»å·¦åˆ°å³
                    () => {
                        const sequence = [];
                        for (let i = 0; i < 5; i++) {
                            const x = (canvas.width / 6) * (i + 1);
                            const y = canvas.height / 2;
                            const types = ['ha', 'ji', 'mi'];
                            const type = types[i % 3];
                            const colors = ['#ff6ec7', '#7873f5', '#4fc3f7'];
                            const color = colors[i % 3];
                            sequence.push({ x, y, type, color });
                        }
                        return sequence;
                    },
                    // æ¨¡å¼3ï¼šåœ†å½¢
                    () => {
                        const sequence = [];
                        const count = 8;
                        const centerX = canvas.width / 2;
                        const centerY = canvas.height / 2;
                        const radius = Math.min(canvas.width, canvas.height) / 3;

                        for (let i = 0; i < count; i++) {
                            const angle = (i / count) * Math.PI * 2;
                            const x = centerX + Math.cos(angle) * radius;
                            const y = centerY + Math.sin(angle) * radius;
                            const types = ['ha', 'ji', 'mi'];
                            const type = types[i % 3];
                            const colors = ['#ff6ec7', '#7873f5', '#4fc3f7'];
                            const color = colors[i % 3];
                            sequence.push({ x, y, type, color });
                        }
                        return sequence;
                    },
                    // æ¨¡å¼4ï¼šéšæœº
                    () => {
                        const sequence = [];
                        const count = 5 + Math.floor(Math.random() * 5);

                        for (let i = 0; i < count; i++) {
                            const x = Math.random() * canvas.width;
                            const regionIndex = Math.floor(Math.random() * 3);
                            const types = ['ha', 'ji', 'mi'];
                            const type = types[regionIndex];
                            const colors = ['#ff6ec7', '#7873f5', '#4fc3f7'];
                            const color = colors[regionIndex];

                            // æ ¹æ®ç±»å‹ç¡®å®šYåæ ‡èŒƒå›´
                            let y;
                            if (type === 'ha') {
                                y = Math.random() * (canvas.height / 3);
                            } else if (type === 'ji') {
                                y = canvas.height / 3 + Math.random() * (canvas.height / 3);
                            } else {
                                y = (canvas.height * 2) / 3 + Math.random() * (canvas.height / 3);
                            }

                            sequence.push({ x, y, type, color });
                        }
                        return sequence;
                    }
                ];

                // è·å–å½“å‰æ¨¡å¼
                const pattern = patterns[autoPattern % patterns.length]();
                autoPattern++;

                return pattern;
            }

            let autoSequence = [];
            let autoIndex = 0;

            function playAutoStep() {
                if (autoIndex >= autoSequence.length) {
                    // è·å–æ–°æ¨¡å¼
                    autoSequence = createAutoPattern();
                    autoIndex = 0;
                }

                const step = autoSequence[autoIndex];
                playSound(step.type);
                circles.push(new Circle(step.x, step.y, step.color, step.type));
                createParticles(step.x, step.y, step.color);
                moveHakimiCharacter(step.x, step.y);

                autoIndex++;
            }

            autoBtn.addEventListener('click', () => {
                if (autoInterval) {
                    clearInterval(autoInterval);
                    autoInterval = null;
                    autoBtn.classList.remove('active');
                    autoBtn.textContent = 'ğŸ¤– è‡ªåŠ¨æ¼”å¥';
                } else {
                    autoSequence = createAutoPattern();
                    autoIndex = 0;
                    autoInterval = setInterval(playAutoStep, 300);
                    autoBtn.classList.add('active');
                    autoBtn.textContent = 'â¹ï¸ åœæ­¢è‡ªåŠ¨';
                }
            });

            // ç§»åŠ¨å“ˆåŸºç±³è§’è‰²
            function moveHakimiCharacter(x, y) {
                // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
                hakimiCharacter.style.transition = 'all 0.5s ease';

                // è®¡ç®—æ–°ä½ç½®ï¼Œç¡®ä¿è§’è‰²åœ¨ç”»å¸ƒå†…
                const characterSize = 80;
                const newX = Math.max(characterSize/2, Math.min(canvas.width - characterSize/2, x));
                const newY = Math.max(characterSize/2, Math.min(canvas.height - characterSize/2, y));

                // è®¾ç½®æ–°ä½ç½®
                hakimiCharacter.style.left = `${newX - characterSize/2}px`;
                hakimiCharacter.style.top = `${newY - characterSize/2}px`;

                // æ·»åŠ å¼¹è·³åŠ¨ç”»
                hakimiCharacter.style.animation = 'none';
                setTimeout(() => {
                    hakimiCharacter.style.animation = 'float 4s ease-in-out infinite';
                }, 10);

                // æ ¹æ®éŸ³æ•ˆç±»å‹æ”¹å˜è¡¨æƒ…
                const region = y < canvas.height / 3 ? 'ha' : y < canvas.height * 2 / 3 ? 'ji' : 'mi';
                if (region === 'ha') {
                    hakimiCharacter.textContent = 'ğŸ˜º';
                } else if (region === 'ji') {
                    hakimiCharacter.textContent = 'ğŸ˜¸';
                } else {
                    hakimiCharacter.textContent = 'ğŸ˜¹';
                }

                // æ¢å¤é»˜è®¤è¡¨æƒ…
                setTimeout(() => {
                    hakimiCharacter.textContent = 'ğŸ±';
                }, 500);
            }

            // æ›´æ–°å¯è§†åŒ–æ•ˆæœ
            function updateVisualizer() {
                const bars = document.querySelectorAll('.visualizer-bar');
                bars.forEach(bar => {
                    const height = Math.random() * 50 + 5;
                    bar.style.height = `${height}px`;
                });
            }

            // å®šæœŸæ›´æ–°å¯è§†åŒ–æ•ˆæœ
            setInterval(updateVisualizer, 200);

            // è®¾ç½®canvaså°ºå¯¸
            function resizeCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // éŸ³é¢‘æ–‡ä»¶è·¯å¾„
            const audioFiles = {
                ha: [
                    'å½’æ¡£-2025-7-11--23-41/å“ˆ1.wav',
                    'å½’æ¡£-2025-7-11--23-41/å“ˆ2.wav',
                    'å½’æ¡£-2025-7-11--23-41/å“ˆ3.wav',
                    'å½’æ¡£-2025-7-11--23-41/å“ˆ4.wav',
                    'å½’æ¡£-2025-7-11--23-41/å“ˆ5.wav'
                ],
                ji: [
                    'å½’æ¡£-2025-7-11--23-41/åŸº1.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº2.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº3.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº4.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº5.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº6.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº7.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº8.wav'
                ],
                mi: [
                    'å½’æ¡£-2025-7-11--23-41/ç±³1.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³2.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³3.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³4.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³5.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³6.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³7.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³8.wav'
                ]
            };

            // é¢„åŠ è½½æ‰€æœ‰éŸ³é¢‘
            const audioElements = {};
            let audioLoaded = 0;
            const totalAudioFiles = Object.keys(audioFiles).reduce((acc, key) => acc + audioFiles[key].length, 0);

            // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();

            // åŠ è½½éŸ³é¢‘æ–‡ä»¶
            Object.keys(audioFiles).forEach(category => {
                audioElements[category] = [];

                audioFiles[category].forEach((file, index) => {
                    const audio = new Audio();
                    audio.src = file;
                    audio.addEventListener('canplaythrough', () => {
                        audioLoaded++;
                        if (audioLoaded === totalAudioFiles) {
                            console.log('æ‰€æœ‰éŸ³é¢‘å·²åŠ è½½å®Œæˆ');
                        }
                    });
                    audioElements[category][index] = audio;
                });
            });

            // ç²’å­ç³»ç»Ÿ
            const particles = [];

            class Particle {
                constructor(x, y, color) {
                    this.x = x;
                    this.y = y;
                    this.color = color;
                    this.size = Math.random() * 15 + 5;
                    this.speedX = Math.random() * 3 - 1.5;
                    this.speedY = Math.random() * 3 - 1.5;
                    this.life = 100;
                }

                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    this.life -= 2;
                    this.size *= 0.98;
                }

                draw() {
                    ctx.save();
                    ctx.globalAlpha = this.life / 100;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            }

            // åœ†åœˆåŠ¨ç”»
            const circles = [];

            class Circle {
                constructor(x, y, color, soundType) {
                    this.x = x;
                    this.y = y;
                    this.radius = 0;
                    this.maxRadius = Math.random() * 100 + 50;
                    this.color = color;
                    this.alpha = 1;
                    this.soundType = soundType;
                }

                update() {
                    if (this.radius < this.maxRadius) {
                        this.radius += 3;
                    } else {
                        this.alpha -= 0.02;
                    }
                }

                draw() {
                    ctx.save();
                    ctx.globalAlpha = this.alpha;
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                }
            }

            // è®°å½•å’Œæ’­æ”¾åŠŸèƒ½
            let isRecording = false;
            let recordedActions = [];
            let recordStartTime = 0;
            let isPlaying = false;

            // æ’­æ”¾å£°éŸ³
            function playSound(category) {
                // éšæœºé€‰æ‹©è¯¥ç±»åˆ«çš„ä¸€ä¸ªéŸ³é¢‘
                const audioArray = audioElements[category];
                const randomIndex = Math.floor(Math.random() * audioArray.length);
                const audio = audioArray[randomIndex];

                // é‡ç½®éŸ³é¢‘å¹¶æ’­æ”¾
                audio.currentTime = 0;
                audio.play().catch(e => console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e));
            }

            // åˆ›å»ºç²’å­çˆ†ç‚¸æ•ˆæœ
            function createParticles(x, y, color, count = 10) {
                for (let i = 0; i < count; i++) {
                    particles.push(new Particle(x, y, color));
                }
            }

            // åŠ¨ç”»å¾ªç¯
            function animate() {
                ctx.fillStyle = 'rgba(30, 30, 46, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // æ›´æ–°å’Œç»˜åˆ¶åœ†åœˆ
                for (let i = circles.length - 1; i >= 0; i--) {
                    circles[i].update();
                    circles[i].draw();

                    if (circles[i].alpha <= 0) {
                        circles.splice(i, 1);
                    }
                }

                // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    particles[i].draw();

                    if (particles[i].life <= 0) {
                        particles.splice(i, 1);
                    }
                }

                requestAnimationFrame(animate);
            }
            animate();

            // å¤„ç†ç”»å¸ƒç‚¹å‡»
            function handleCanvasClick(e) {
                // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²å¯åŠ¨
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // æ ¹æ®ç‚¹å‡»ä½ç½®å†³å®šå£°éŸ³ç±»å‹å’Œé¢œè‰²
                let soundType, color;

                // å°†ç”»å¸ƒåˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼šä¸Šã€ä¸­ã€ä¸‹
                if (y < canvas.height / 3) {
                    soundType = 'ha';
                    color = '#ff6ec7'; // ç²‰è‰²
                } else if (y < (canvas.height * 2) / 3) {
                    soundType = 'ji';
                    color = '#7873f5'; // ç´«è‰²
                } else {
                    soundType = 'mi';
                    color = '#4fc3f7'; // è“è‰²
                }

                // æ’­æ”¾å£°éŸ³
                playSound(soundType);

                // åˆ›å»ºåœ†åœˆå’Œç²’å­
                circles.push(new Circle(x, y, color, soundType));
                createParticles(x, y, color);

                // ç§»åŠ¨å“ˆåŸºç±³è§’è‰²
                moveHakimiCharacter(x, y);

                // è®°å½•åŠ¨ä½œ
                if (isRecording) {
                    recordedActions.push({
                        time: Date.now() - recordStartTime,
                        x: x,
                        y: y,
                        soundType: soundType
                    });
                }
            }

            canvas.addEventListener('click', handleCanvasClick);

            // å¤„ç†é¼ æ ‡æ‹–åŠ¨
            let isMouseDown = false;
            let lastTriggerTime = 0;

            canvas.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                handleCanvasClick(e);
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isMouseDown) {
                    const now = Date.now();
                    // é™åˆ¶è§¦å‘é¢‘ç‡
                    if (now - lastTriggerTime > 100) {
                        handleCanvasClick(e);
                        lastTriggerTime = now;
                    }
                }
            });

            canvas.addEventListener('mouseup', () => {
                isMouseDown = false;
            });

            canvas.addEventListener('mouseleave', () => {
                isMouseDown = false;
            });

            // æ¸…é™¤æŒ‰é’®
            clearBtn.addEventListener('click', () => {
                circles.length = 0;
                particles.length = 0;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });

            // å½•åˆ¶æŒ‰é’®
            recordBtn.addEventListener('click', () => {
                if (!isRecording) {
                    isRecording = true;
                    recordedActions = [];
                    recordStartTime = Date.now();
                    recordBtn.textContent = 'åœæ­¢å½•åˆ¶';
                    recordBtn.style.background = 'rgba(255, 110, 199, 0.3)';
                } else {
                    isRecording = false;
                    recordBtn.textContent = 'å½•åˆ¶éŸ³ä¹';
                    recordBtn.style.background = 'rgba(255, 255, 255, 0.1)';

                    if (recordedActions.length > 0) {
                        playbackBtn.disabled = false;
                    }
                }
            });

            // æ’­æ”¾å½•åˆ¶æŒ‰é’®
            playbackBtn.addEventListener('click', () => {
                if (recordedActions.length === 0 || isPlaying) return;

                isPlaying = true;
                playbackBtn.disabled = true;
                playbackBtn.textContent = 'æ’­æ”¾ä¸­...';

                // æŒ‰é¡ºåºæ’­æ”¾å½•åˆ¶çš„åŠ¨ä½œ
                recordedActions.forEach(action => {
                    setTimeout(() => {
                        // ç¡®å®šé¢œè‰²
                        let color;
                        if (action.soundType === 'ha') {
                            color = '#ff6ec7';
                        } else if (action.soundType === 'ji') {
                            color = '#7873f5';
                        } else {
                            color = '#4fc3f7';
                        }

                        // æ’­æ”¾å£°éŸ³
                        playSound(action.soundType);

                        // åˆ›å»ºè§†è§‰æ•ˆæœ
                        circles.push(new Circle(action.x, action.y, color, action.soundType));
                        createParticles(action.x, action.y, color);

                        // ç§»åŠ¨å“ˆåŸºç±³è§’è‰²
                        moveHakimiCharacter(action.x, action.y);

                        // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªåŠ¨ä½œ
                        if (action === recordedActions[recordedActions.length - 1]) {
                            setTimeout(() => {
                                isPlaying = false;
                                playbackBtn.disabled = false;
                                playbackBtn.textContent = 'æ’­æ”¾å½•åˆ¶';
                            }, 1000);
                        }
                    }, action.time);
                });
            });

            // åˆå§‹æç¤º
            setTimeout(() => {
                // åˆ›å»ºä¸€ä¸ªæ¼”ç¤ºåœ†åœˆ
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                circles.push(new Circle(centerX, centerY, '#ff6ec7', 'ha'));
                createParticles(centerX, centerY, '#ff6ec7', 20);
                playSound('ha');
                moveHakimiCharacter(centerX, centerY);

                setTimeout(() => {
                    circles.push(new Circle(centerX, centerY + 100, '#7873f5', 'ji'));
                    createParticles(centerX, centerY + 100, '#7873f5', 20);
                    playSound('ji');
                    moveHakimiCharacter(centerX, centerY + 100);
                }, 500);

                setTimeout(() => {
                    circles.push(new Circle(centerX, centerY + 200, '#4fc3f7', 'mi'));
                    createParticles(centerX, centerY + 200, '#4fc3f7', 20);
                    playSound('mi');
                    moveHakimiCharacter(centerX, centerY + 200);
                }, 1000);

                // æ˜¾ç¤ºèƒŒæ™¯éŸ³ä¹æç¤º
                setTimeout(() => {
                    const info = document.querySelector('.info');
                    info.textContent = 'è¯•è¯•å¼€å¯èƒŒæ™¯éŸ³ä¹ï¼Œäº«å—æ›´å®Œæ•´çš„ä½“éªŒï¼';
                    setTimeout(() => {
                        info.textContent = 'ç‚¹å‡»ç”»å¸ƒåˆ›ä½œä½ çš„éŸ³ä¹';
                    }, 3000);
                }, 2000);
            }, 1000);
        });
    </script>
</body>
</html>