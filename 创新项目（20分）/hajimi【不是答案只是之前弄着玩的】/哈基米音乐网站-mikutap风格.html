<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“ˆåŸºç±³äº’åŠ¨éŸ³ä¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            background: #222;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            font-family: Arial, sans-serif;
            cursor: crosshair;
        }

        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .header {
            position: fixed;
            top: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 10;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            background: linear-gradient(90deg, #ff6ec7, #7873f5, #4fc3f7);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: pulse 2s infinite, gradientShift 5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 10;
        }

        button {
            padding: 12px 24px; /* å¢å¤§æŒ‰é’®å°ºå¯¸ï¼Œæ»¡è¶³ç§»åŠ¨ç«¯æœ€å°ç‚¹å‡»åŒºåŸŸè¦æ±‚ */
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            min-height: 48px; /* ç¡®ä¿æŒ‰é’®é«˜åº¦æ»¡è¶³ç§»åŠ¨ç«¯æœ€å°ç‚¹å‡»åŒºåŸŸ */
            min-width: 48px; /* ç¡®ä¿æŒ‰é’®å®½åº¦æ»¡è¶³ç§»åŠ¨ç«¯æœ€å°ç‚¹å‡»åŒºåŸŸ */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 110, 199, 0.3);
        }

        /* ç§»åŠ¨ç«¯è§¦æ‘¸åé¦ˆ */
        button:active {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-1px);
        }

        .info {
            position: fixed;
            top: 70px;
            width: 100%;
            text-align: center;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            z-index: 10;
        }

        .footer {
            position: fixed;
            bottom: 60px;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            z-index: 10;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #222;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }

        .loading-text {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .loading-status {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 15px;
            min-height: 20px;
            text-align: center;
        }

        .loading-bar {
            width: 200px;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #ff6ec7, #7873f5, #4fc3f7);
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-character {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-15px) scale(1.1); }
        }

        .bgm-control {
            position: fixed;
            top: 100px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }

        .volume-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #ff6ec7;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #ff6ec7;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .character {
            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 150px;
            right: 30px;
            z-index: 5;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-character">ğŸ±</div>
        <div class="loading-text">æ­£åœ¨åŠ è½½å“ˆåŸºç±³éŸ³æ•ˆ...</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div class="loading-status" id="loadingStatus">å‡†å¤‡éŸ³é¢‘ç³»ç»Ÿ...</div>
    </div>

    <div class="header">
        <h1 class="title">å“ˆåŸºç±³äº’åŠ¨éŸ³ä¹</h1>
    </div>

    <div class="info">
        ç‚¹å‡»æˆ–æ‹–åŠ¨é¼ æ ‡åˆ›ä½œä½ çš„éŸ³ä¹
    </div>

    <div class="bgm-control">
        <label>èƒŒæ™¯éŸ³ä¹</label>
        <button id="bgmToggle">ğŸ”‡</button>
        <input type="range" class="volume-slider" id="bgmVolume" min="0" max="100" value="30">
    </div>

    <canvas id="canvas"></canvas>

    <div class="footer">
        æç¤ºï¼šç‚¹å‡»ä¸åŒä½ç½®è§¦å‘ä¸åŒçš„"å“ˆ"ã€"åŸº"ã€"ç±³"éŸ³æ•ˆ | é”®ç›˜å¿«æ·é”®ï¼šç©ºæ ¼(èƒŒæ™¯éŸ³ä¹) R(å½•åˆ¶) P(å›æ”¾) C(æ¸…é™¤) G(éšæœº) æ–¹å‘é”®/1-3(è§¦å‘éŸ³æ•ˆ)
    </div>

    <div class="controls">
        <button id="clearBtn">æ¸…é™¤</button>
        <button id="randomBtn">éšæœºæ¼”å¥</button>
        <button id="recordBtn">å½•åˆ¶</button>
        <button id="playbackBtn">å›æ”¾</button>
    </div>

    <div class="character">ğŸ±</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const loading = document.getElementById('loading');
            const loadingProgress = document.getElementById('loadingProgress');
            const bgmToggle = document.getElementById('bgmToggle');
            const bgmVolume = document.getElementById('bgmVolume');
            const clearBtn = document.getElementById('clearBtn');
            const randomBtn = document.getElementById('randomBtn');
            const recordBtn = document.getElementById('recordBtn');
            const playbackBtn = document.getElementById('playbackBtn');

            // è®¾ç½®canvaså°ºå¯¸
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // éŸ³é¢‘æ–‡ä»¶è·¯å¾„
            const audioFiles = {
                ha: [
                    'å½’æ¡£-2025-7-11--23-41/å“ˆ1.wav',
                    'å½’æ¡£-2025-7-11--23-41/å“ˆ2.wav',
                    'å½’æ¡£-2025-7-11--23-41/å“ˆ3.wav',
                    'å½’æ¡£-2025-7-11--23-41/å“ˆ4.wav',
                    'å½’æ¡£-2025-7-11--23-41/å“ˆ5.wav'
                ],
                ji: [
                    'å½’æ¡£-2025-7-11--23-41/åŸº1.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº2.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº3.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº4.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº5.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº6.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº7.wav',
                    'å½’æ¡£-2025-7-11--23-41/åŸº8.wav'
                ],
                mi: [
                    'å½’æ¡£-2025-7-11--23-41/ç±³1.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³2.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³3.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³4.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³5.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³6.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³7.wav',
                    'å½’æ¡£-2025-7-11--23-41/ç±³8.wav'
                ]
            };

            // éŸ³é¢‘ç³»ç»Ÿ - ä¼˜åŒ–ä¸ºæŒ‰éœ€åŠ è½½
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();
            const audioElements = {};
            const audioCache = {}; // æ·»åŠ ç¼“å­˜æœºåˆ¶
            const loadingPromises = {}; // å­˜å‚¨åŠ è½½ä¸­çš„Promise

            // åˆå§‹åŒ–éŸ³é¢‘å…ƒç´ æ•°ç»„
            Object.keys(audioFiles).forEach(category => {
                audioElements[category] = [];
                audioCache[category] = [];
                loadingPromises[category] = [];

                // åˆå§‹åŒ–ç¼“å­˜æ•°ç»„
                audioFiles[category].forEach((file, index) => {
                    audioCache[category][index] = null;
                    loadingPromises[category][index] = null;
                });
            });

            // æŒ‰éœ€åŠ è½½éŸ³é¢‘å‡½æ•°
            async function loadAudioOnDemand(category, index) {
                // å¦‚æœå·²ç»ç¼“å­˜ï¼Œç›´æ¥è¿”å›
                if (audioCache[category][index]) {
                    return audioCache[category][index];
                }

                // å¦‚æœæ­£åœ¨åŠ è½½ä¸­ï¼Œè¿”å›Promise
                if (loadingPromises[category][index]) {
                    return loadingPromises[category][index];
                }

                // åˆ›å»ºæ–°çš„åŠ è½½Promise
                const loadPromise = new Promise((resolve, reject) => {
                    const audio = new Audio();
                    audio.src = audioFiles[category][index];

                    audio.addEventListener('canplaythrough', () => {
                        audioCache[category][index] = audio;
                        loadingPromises[category][index] = null;
                        resolve(audio);
                    });

                    audio.addEventListener('error', (e) => {
                        loadingPromises[category][index] = null;
                        console.error(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${audioFiles[category][index]}`, e);
                        reject(e);
                    });

                    // å¼€å§‹åŠ è½½
                    audio.load();
                });

                // å­˜å‚¨Promise
                loadingPromises[category][index] = loadPromise;

                // è¿”å›Promise
                return loadPromise;
            }

            // åˆå§‹åªåŠ è½½æ¯ç§ç±»å‹çš„ç¬¬ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ - æ·»åŠ è¯¦ç»†çŠ¶æ€æç¤º
            async function initAudioLoading() {
                const loadingStatus = document.getElementById('loadingStatus');
                loadingProgress.style.width = '10%';

                try {
                    // åŠ è½½"å“ˆ"éŸ³æ•ˆ
                    loadingStatus.textContent = 'æ­£åœ¨åŠ è½½"å“ˆ"éŸ³æ•ˆ...';
                    await loadAudioOnDemand('ha', 0);
                    loadingProgress.style.width = '40%';

                    // åŠ è½½"åŸº"éŸ³æ•ˆ
                    loadingStatus.textContent = 'æ­£åœ¨åŠ è½½"åŸº"éŸ³æ•ˆ...';
                    await loadAudioOnDemand('ji', 0);
                    loadingProgress.style.width = '70%';

                    // åŠ è½½"ç±³"éŸ³æ•ˆ
                    loadingStatus.textContent = 'æ­£åœ¨åŠ è½½"ç±³"éŸ³æ•ˆ...';
                    await loadAudioOnDemand('mi', 0);
                    loadingProgress.style.width = '100%';

                    // åŠ è½½å®Œæˆ
                    loadingStatus.textContent = 'éŸ³æ•ˆåŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ªï¼';

                    setTimeout(() => {
                        loading.style.opacity = '0';
                        setTimeout(() => {
                            loading.style.display = 'none';
                        }, 500);
                    }, 500);
                } catch (error) {
                    console.error('åˆå§‹éŸ³é¢‘åŠ è½½å¤±è´¥:', error);
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    loadingStatus.textContent = 'éƒ¨åˆ†éŸ³æ•ˆåŠ è½½å¤±è´¥ï¼Œä½†æ‚¨å¯ä»¥ç»§ç»­ä½¿ç”¨';

                    // å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿéšè—åŠ è½½ç•Œé¢ï¼Œé¿å…ç”¨æˆ·å¡ä½
                    setTimeout(() => {
                        loading.style.opacity = '0';
                        setTimeout(() => {
                            loading.style.display = 'none';
                        }, 500);
                    }, 1500);
                }
            }

            // è°ƒç”¨åˆå§‹åŠ è½½
            initAudioLoading();

            // èƒŒæ™¯éŸ³ä¹ç³»ç»Ÿ
            let bgmEnabled = false;
            let bgmGainNode = null;
            let bgmOscillator = null;

            function createBGM() {
                if (!audioContext) return;

                if (bgmOscillator) {
                    bgmOscillator.stop();
                    bgmOscillator = null;
                }

                if (!bgmEnabled) return;

                bgmOscillator = audioContext.createOscillator();
                bgmGainNode = audioContext.createGain();

                const volume = bgmVolume.value / 100;
                bgmGainNode.gain.value = volume * 0.1;

                bgmOscillator.connect(bgmGainNode);
                bgmGainNode.connect(audioContext.destination);

                bgmOscillator.type = 'sine';
                bgmOscillator.frequency.value = 220;

                const now = audioContext.currentTime;
                const melody = [
                    { time: now, freq: 220, duration: 0.5 },
                    { time: now + 0.5, freq: 246.94, duration: 0.5 },
                    { time: now + 1, freq: 261.63, duration: 0.5 },
                    { time: now + 1.5, freq: 293.66, duration: 0.5 },
                    { time: now + 2, freq: 329.63, duration: 1 },
                    { time: now + 3, freq: 293.66, duration: 0.5 },
                    { time: now + 3.5, freq: 261.63, duration: 0.5 },
                    { time: now + 4, freq: 246.94, duration: 1 },
                ];

                bgmOscillator.start();

                melody.forEach(note => {
                    bgmOscillator.frequency.setValueAtTime(note.freq, note.time);
                });

                setTimeout(() => {
                    if (bgmEnabled) {
                        createBGM();
                    }
                }, 5000);
            }

            bgmToggle.addEventListener('click', () => {
                bgmEnabled = !bgmEnabled;
                bgmToggle.textContent = bgmEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
                bgmToggle.classList.toggle('active', bgmEnabled);

                if (bgmEnabled) {
                    createBGM();
                } else if (bgmOscillator) {
                    bgmOscillator.stop();
                    bgmOscillator = null;
                }
            });

            bgmVolume.addEventListener('input', () => {
                if (bgmGainNode) {
                    const volume = bgmVolume.value / 100;
                    bgmGainNode.gain.value = volume * 0.1;
                }
            });

            // ç²’å­ç³»ç»Ÿ - ä¼˜åŒ–æ€§èƒ½
            const particles = [];
            const maxParticles = 50; // é™ä½æœ€å¤§ç²’å­æ•°é‡

            class Particle {
                constructor(x, y, color) {
                    this.x = x;
                    this.y = y;
                    this.color = color;
                    this.size = Math.random() * 10 + 3; // å‡å°åˆå§‹å°ºå¯¸
                    this.speedX = Math.random() * 4 - 2; // å‡å°é€Ÿåº¦èŒƒå›´
                    this.speedY = Math.random() * 4 - 2;
                    this.life = 100;
                    this.decay = Math.random() * 0.8 + 0.7; // åŠ å¿«è¡°å‡é€Ÿåº¦
                    this.gravity = 0.05;
                    this.rotation = Math.random() * Math.PI * 2;
                    this.rotationSpeed = (Math.random() - 0.5) * 0.1;
                }

                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    this.speedY += this.gravity;
                    this.life -= this.decay;
                    this.size *= 0.96; // åŠ å¿«å°ºå¯¸ç¼©å‡
                    this.rotation += this.rotationSpeed;
                }

                // ä¼˜åŒ–ç²’å­æ›´æ–°é€»è¾‘ï¼Œæå‰è¿‡æ»¤è¶…å‡ºç”»å¸ƒçš„ç²’å­
                isInBounds() {
                    return this.life > 0 && 
                           this.x > -50 && this.x < canvas.width + 50 && 
                           this.y > -50 && this.y < canvas.height + 50;
                }

                draw() {
                    ctx.save();
                    ctx.globalAlpha = this.life / 100;
                    ctx.fillStyle = this.color;
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation);
                    ctx.beginPath();
                    // ç®€åŒ–æ˜Ÿå½¢ç»˜åˆ¶ï¼Œå‡å°‘è®¡ç®—é‡
                    const spikes = 5;
                    const outerRadius = this.size;
                    const innerRadius = this.size * 0.5;

                    for (let i = 0; i < spikes * 2; i++) {
                        const radius = i % 2 === 0 ? outerRadius : innerRadius;
                        const angle = (i * Math.PI) / spikes;
                        const x = Math.cos(angle) * radius;
                        const y = Math.sin(angle) * radius;

                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }

                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                }
            }

            // åœ†åœˆåŠ¨ç”»ç³»ç»Ÿ
            const circles = [];

            class Circle {
                constructor(x, y, color, soundType) {
                    this.x = x;
                    this.y = y;
                    this.radius = 0;
                    this.maxRadius = Math.random() * 100 + 50;
                    this.color = color;
                    this.alpha = 1;
                    this.soundType = soundType;
                    this.pulsePhase = 0; // æ·»åŠ è„‰å†²ç›¸ä½
                    this.innerCircles = []; // å†…éƒ¨åœ†åœˆ

                    // åˆ›å»ºå†…éƒ¨åœ†åœˆ
                    const innerCount = Math.floor(Math.random() * 3) + 1;
                    for (let i = 0; i < innerCount; i++) {
                        this.innerCircles.push({
                            radius: 0,
                            maxRadius: this.maxRadius * (0.3 + Math.random() * 0.4),
                            delay: i * 5,
                            alpha: 1
                        });
                    }
                }

                update() {
                    if (this.radius < this.maxRadius) {
                        this.radius += 3;
                    } else {
                        this.alpha -= 0.02;
                    }

                    // æ·»åŠ è„‰å†²æ•ˆæœ
                    this.pulsePhase += 0.1;

                    // æ›´æ–°å†…éƒ¨åœ†åœˆ
                    this.innerCircles.forEach(circle => {
                        if (circle.delay > 0) {
                            circle.delay--;
                        } else if (circle.radius < circle.maxRadius) {
                            circle.radius += 2;
                        } else {
                            circle.alpha -= 0.02;
                        }
                    });
                }

                draw() {
                    ctx.save();
                    ctx.globalAlpha = this.alpha;

                    // ç»˜åˆ¶ä¸»åœ†åœˆ
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 2 + Math.sin(this.pulsePhase) * 1; // è„‰å†²çº¿å®½
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.stroke();

                    // ç»˜åˆ¶å†…éƒ¨åœ†åœˆ
                    this.innerCircles.forEach(circle => {
                        if (circle.delay <= 0) {
                            ctx.save();
                            ctx.globalAlpha = this.alpha * circle.alpha;
                            ctx.strokeStyle = this.color;
                            ctx.lineWidth = 1;
                            ctx.beginPath();
                            ctx.arc(this.x, this.y, circle.radius, 0, Math.PI * 2);
                            ctx.stroke();
                            ctx.restore();
                        }
                    });

                    ctx.restore();
                }
            }

            // æ’­æ”¾å£°éŸ³ - é€‚é…æŒ‰éœ€åŠ è½½ç³»ç»Ÿ
            async function playSound(category) {
                // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²å¯åŠ¨
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                try {
                    // è·å–è¯¥ç±»å‹çš„éŸ³é¢‘æ–‡ä»¶æ•°é‡
                    const fileCount = audioFiles[category].length;
                    if (fileCount === 0) return;

                    // éšæœºé€‰æ‹©ä¸€ä¸ªç´¢å¼•
                    const randomIndex = Math.floor(Math.random() * fileCount);

                    // æŒ‰éœ€åŠ è½½éŸ³é¢‘
                    const audio = await loadAudioOnDemand(category, randomIndex);

                    // æ’­æ”¾éŸ³é¢‘
                    audio.currentTime = 0;
                    audio.play().catch(e => console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e));
                } catch (error) {
                    console.error(`æ’­æ”¾${category}ç±»å‹éŸ³é¢‘å¤±è´¥:`, error);
                    // å¦‚æœå‡ºé”™ï¼Œå°è¯•æ’­æ”¾é»˜è®¤çš„ç¬¬ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶
                    try {
                        const audio = await loadAudioOnDemand(category, 0);
                        audio.currentTime = 0;
                        audio.play().catch(e => console.error('é»˜è®¤éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e));
                    } catch (fallbackError) {
                        console.error('æ’­æ”¾é»˜è®¤éŸ³é¢‘ä¹Ÿå¤±è´¥:', fallbackError);
                    }
                }
            }

            // åˆ›å»ºç²’å­çˆ†ç‚¸æ•ˆæœ
            function createParticles(x, y, color, count = 10) {
                // é™åˆ¶ç²’å­æ•°é‡ä»¥æé«˜æ€§èƒ½
                const particlesToCreate = Math.min(count, maxParticles - particles.length);

                for (let i = 0; i < particlesToCreate; i++) {
                    particles.push(new Particle(x, y, color));
                }
            }

            // å½•åˆ¶å’Œæ’­æ”¾åŠŸèƒ½
            let isRecording = false;
            let recordedActions = [];
            let recordStartTime = 0;
            let isPlaying = false;

            // æ·»åŠ é¼ æ ‡ä½ç½®è·Ÿè¸ª
            let lastMouseX = null;
            let lastMouseY = null;

            // åŠ¨ç”»å¾ªç¯ - ä¼˜åŒ–æ€§èƒ½
            function animate() {
                // æ¸…é™¤ç”»å¸ƒ - ä½¿ç”¨requestAnimationFrameç¡®ä¿å¸§ç‡ç¨³å®š
                ctx.fillStyle = 'rgba(34, 34, 34, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // æ›´æ–°å’Œç»˜åˆ¶åœ†åœˆ
                for (let i = circles.length - 1; i >= 0; i--) {
                    circles[i].update();
                    circles[i].draw();

                    if (circles[i].alpha <= 0) {
                        circles.splice(i, 1);
                    }
                }

                // ä¼˜åŒ–ç²’å­æ›´æ–°å’Œç»˜åˆ¶ - æå‰è¿‡æ»¤è¶…å‡ºç”»å¸ƒçš„ç²’å­
                for (let i = particles.length - 1; i >= 0; i--) {
                    const particle = particles[i];
                    particle.update();

                    // ä½¿ç”¨isInBoundsæ–¹æ³•æå‰è¿‡æ»¤
                    if (!particle.isInBounds()) {
                        particles.splice(i, 1);
                        continue;
                    }

                    particle.draw();
                }

                // æ›´æ–°å°çŒ«è§’è‰²ä½ç½®
                const character = document.querySelector('.character');
                if (character) {
                    // æ·»åŠ å¾®å¦™çš„é¼ æ ‡è·Ÿéšæ•ˆæœ
                    const mouseX = lastMouseX || canvas.width / 2;
                    const mouseY = lastMouseY || canvas.height / 2;
                    const offsetX = (mouseX - canvas.width / 2) * 0.05;
                    const offsetY = (mouseY - canvas.height / 2) * 0.05;
                    character.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
                }

                requestAnimationFrame(animate);
            }
            animate();

            // åŒºåŸŸé«˜äº®æ•ˆæœ
            let highlightTimeout = null;
            let currentHighlight = null;

            // åˆ›å»ºåŒºåŸŸé«˜äº®å…ƒç´ 
            function createHighlightElement() {
                const highlight = document.createElement('div');
                highlight.style.position = 'fixed';
                highlight.style.pointerEvents = 'none';
                highlight.style.zIndex = '5';
                highlight.style.transition = 'opacity 0.3s ease';
                highlight.style.opacity = '0';
                document.body.appendChild(highlight);
                return highlight;
            }

            // åˆå§‹åŒ–é«˜äº®å…ƒç´ 
            const areaHighlight = createHighlightElement();

            // æ˜¾ç¤ºåŒºåŸŸé«˜äº®
            function showAreaHighlight(soundType, x, y) {
                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®è®¡æ—¶å™¨
                if (highlightTimeout) {
                    clearTimeout(highlightTimeout);
                }

                // è®¾ç½®é«˜äº®é¢œè‰²
                let color;
                if (soundType === 'ha') {
                    color = 'rgba(255, 110, 199, 0.2)'; // åŠé€æ˜ç²‰è‰²
                } else if (soundType === 'ji') {
                    color = 'rgba(120, 115, 245, 0.2)'; // åŠé€æ˜ç´«è‰²
                } else {
                    color = 'rgba(79, 195, 247, 0.2)'; // åŠé€æ˜è“è‰²
                }

                // è®¾ç½®é«˜äº®åŒºåŸŸ
                let top, height;
                if (soundType === 'ha') {
                    top = 0;
                    height = canvas.height / 3;
                } else if (soundType === 'ji') {
                    top = canvas.height / 3;
                    height = canvas.height / 3;
                } else {
                    top = (canvas.height * 2) / 3;
                    height = canvas.height / 3;
                }

                // åº”ç”¨é«˜äº®æ ·å¼
                areaHighlight.style.left = '0';
                areaHighlight.style.top = `${top}px`;
                areaHighlight.style.width = '100%';
                areaHighlight.style.height = `${height}px`;
                areaHighlight.style.backgroundColor = color;
                areaHighlight.style.opacity = '1';

                // è®¾ç½®é«˜äº®æ¶ˆå¤±è®¡æ—¶å™¨
                highlightTimeout = setTimeout(() => {
                    areaHighlight.style.opacity = '0';
                }, 300);
            }

            // å¤„ç†ç”»å¸ƒç‚¹å‡» - å¢åŠ äº¤äº’åé¦ˆ
            function handleCanvasClick(x, y) {
                // æ ¹æ®ç‚¹å‡»ä½ç½®å†³å®šå£°éŸ³ç±»å‹å’Œé¢œè‰²
                let soundType, color;

                // å°†ç”»å¸ƒåˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼šä¸Šã€ä¸­ã€ä¸‹
                if (y < canvas.height / 3) {
                    soundType = 'ha';
                    color = '#ff6ec7'; // ç²‰è‰²
                } else if (y < (canvas.height * 2) / 3) {
                    soundType = 'ji';
                    color = '#7873f5'; // ç´«è‰²
                } else {
                    soundType = 'mi';
                    color = '#4fc3f7'; // è“è‰²
                }

                // æ˜¾ç¤ºåŒºåŸŸé«˜äº®
                showAreaHighlight(soundType, x, y);

                // ç§»åŠ¨ç«¯è§¦æ„Ÿåé¦ˆ
                if (navigator.vibrate) {
                    navigator.vibrate(50); // çŸ­æŒ¯åŠ¨50æ¯«ç§’
                }

                // æ’­æ”¾å£°éŸ³
                playSound(soundType);

                // åˆ›å»ºåœ†åœˆå’Œç²’å­ - å¢åŠ æ•°é‡ä»¥å¢å¼ºåé¦ˆ
                circles.push(new Circle(x, y, color, soundType));
                createParticles(x, y, color, 15); // å¢åŠ ç²’å­æ•°é‡

                // è®°å½•åŠ¨ä½œ
                if (isRecording) {
                    recordedActions.push({
                        time: Date.now() - recordStartTime,
                        x: x,
                        y: y,
                        soundType: soundType
                    });
                }
            }

            // é¼ æ ‡äº‹ä»¶
            let isMouseDown = false;
            let lastTriggerTime = 0;

            canvas.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                handleCanvasClick(e.clientX, e.clientY);
            });

            canvas.addEventListener('mousemove', (e) => {
                // æ›´æ–°é¼ æ ‡ä½ç½®
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;

                if (isMouseDown) {
                    const now = Date.now();
                    if (now - lastTriggerTime > 100) {
                        handleCanvasClick(e.clientX, e.clientY);
                        lastTriggerTime = now;
                    }
                }
            });

            canvas.addEventListener('mouseup', () => {
                isMouseDown = false;
            });

            canvas.addEventListener('mouseleave', () => {
                isMouseDown = false;
            });

            // è§¦æ‘¸äº‹ä»¶æ”¯æŒ - ä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒ
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isMouseDown = true;
                const touch = e.touches[0];
                handleCanvasClick(touch.clientX, touch.clientY);

                // è§¦æ‘¸å¼€å§‹æ—¶ç«‹å³æ›´æ–°é¼ æ ‡ä½ç½®
                lastMouseX = touch.clientX;
                lastMouseY = touch.clientY;
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];

                // æ›´æ–°é¼ æ ‡ä½ç½®
                lastMouseX = touch.clientX;
                lastMouseY = touch.clientY;

                if (isMouseDown) {
                    const now = Date.now();
                    // å¢åŠ è§¦å‘é—´éš”ï¼Œå‡å°‘è§¦æ‘¸å¯†é›†åº¦ï¼Œæé«˜æ€§èƒ½
                    if (now - lastTriggerTime > 150) {
                        handleCanvasClick(touch.clientX, touch.clientY);
                        lastTriggerTime = now;
                    }
                }
            });

            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                isMouseDown = false;
            });

            // æ·»åŠ è§¦æ‘¸å–æ¶ˆäº‹ä»¶å¤„ç†
            canvas.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                isMouseDown = false;
            });

            // æ¸…é™¤æŒ‰é’®
            clearBtn.addEventListener('click', () => {
                circles.length = 0;
                particles.length = 0;
            });

            // éšæœºèŠ‚å¥åŠŸèƒ½
            let randomInterval = null;
            let randomPatterns = [
                // åˆ›å»ºå‡ ç§èŠ‚å¥æ¨¡å¼
                { pattern: ['ha', 'ha', 'ji', 'mi'], interval: 400 },
                { pattern: ['ha', 'ji', 'ha', 'mi', 'ji'], interval: 300 },
                { pattern: ['mi', 'mi', 'ji', 'ha', 'ha'], interval: 350 },
                { pattern: ['ha', 'ji', 'mi', 'ha', 'ji', 'mi'], interval: 250 }
            ];
            let currentPatternIndex = 0;
            let currentStepIndex = 0;

            function createRandomRhythm() {
                const regions = ['ha', 'ji', 'mi'];
                const colors = ['#ff6ec7', '#7873f5', '#4fc3f7'];

                // ä½¿ç”¨é¢„å®šä¹‰çš„èŠ‚å¥æ¨¡å¼
                const currentPattern = randomPatterns[currentPatternIndex];
                const region = currentPattern.pattern[currentStepIndex];
                const color = colors[regions.indexOf(region)];

                // æ›´æ–°æ­¥éª¤ç´¢å¼•
                currentStepIndex++;
                if (currentStepIndex >= currentPattern.pattern.length) {
                    currentStepIndex = 0;
                    // éšæœºåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¨¡å¼
                    currentPatternIndex = Math.floor(Math.random() * randomPatterns.length);
                    // æ›´æ–°é—´éš”
                    if (randomInterval) {
                        clearInterval(randomInterval);
                        randomInterval = setInterval(createRandomRhythm, currentPattern.interval);
                    }
                }

                let y;
                if (region === 'ha') {
                    y = Math.random() * (canvas.height / 3);
                } else if (region === 'ji') {
                    y = canvas.height / 3 + Math.random() * (canvas.height / 3);
                } else {
                    y = (canvas.height * 2) / 3 + Math.random() * (canvas.height / 3);
                }

                const x = Math.random() * canvas.width;

                playSound(region);
                circles.push(new Circle(x, y, color, region));
                createParticles(x, y, color, 15); // å¢åŠ ç²’å­æ•°é‡
            }

            randomBtn.addEventListener('click', () => {
                if (randomInterval) {
                    clearInterval(randomInterval);
                    randomInterval = null;
                    randomBtn.textContent = 'éšæœºæ¼”å¥';
                } else {
                    // é‡ç½®æ¨¡å¼ç´¢å¼•
                    currentPatternIndex = 0;
                    currentStepIndex = 0;
                    // å¼€å§‹éšæœºæ¼”å¥
                    createRandomRhythm(); // ç«‹å³è§¦å‘ç¬¬ä¸€ä¸ª
                    const initialPattern = randomPatterns[0];
                    randomInterval = setInterval(createRandomRhythm, initialPattern.interval);
                    randomBtn.textContent = 'åœæ­¢éšæœº';
                }
            });

            // å½•åˆ¶æŒ‰é’®
            recordBtn.addEventListener('click', () => {
                if (!isRecording) {
                    isRecording = true;
                    recordedActions = [];
                    recordStartTime = Date.now();
                    recordBtn.textContent = 'åœæ­¢å½•åˆ¶';
                    recordBtn.classList.add('active');
                } else {
                    isRecording = false;
                    recordBtn.textContent = 'å½•åˆ¶';
                    recordBtn.classList.remove('active');

                    if (recordedActions.length > 0) {
                        playbackBtn.disabled = false;
                    }
                }
            });

            // æ’­æ”¾å½•åˆ¶æŒ‰é’®
            playbackBtn.addEventListener('click', () => {
                if (recordedActions.length === 0 || isPlaying) return;

                isPlaying = true;
                playbackBtn.disabled = true;
                playbackBtn.textContent = 'æ’­æ”¾ä¸­...';

                recordedActions.forEach(action => {
                    setTimeout(() => {
                        let color;
                        if (action.soundType === 'ha') {
                            color = '#ff6ec7';
                        } else if (action.soundType === 'ji') {
                            color = '#7873f5';
                        } else {
                            color = '#4fc3f7';
                        }

                        playSound(action.soundType);
                        circles.push(new Circle(action.x, action.y, color, action.soundType));
                        createParticles(action.x, action.y, color);

                        if (action === recordedActions[recordedActions.length - 1]) {
                            setTimeout(() => {
                                isPlaying = false;
                                playbackBtn.disabled = false;
                                playbackBtn.textContent = 'å›æ”¾';
                            }, 1000);
                        }
                    }, action.time);
                });
            });

            // é”®ç›˜å¿«æ·é”®æ”¯æŒ
            document.addEventListener('keydown', (e) => {
                // é˜²æ­¢åœ¨è¾“å…¥æ¡†ä¸­è§¦å‘
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                switch(e.key) {
                    // ç©ºæ ¼é”®ï¼šæ’­æ”¾/æš‚åœèƒŒæ™¯éŸ³ä¹
                    case ' ':
                        e.preventDefault();
                        bgmToggle.click();
                        break;
                    // Ré”®ï¼šå¼€å§‹/åœæ­¢å½•åˆ¶
                    case 'r':
                    case 'R':
                        recordBtn.click();
                        break;
                    // Pé”®ï¼šå›æ”¾å½•åˆ¶
                    case 'p':
                    case 'P':
                        if (!playbackBtn.disabled) {
                            playbackBtn.click();
                        }
                        break;
                    // Cé”®ï¼šæ¸…é™¤ç”»å¸ƒ
                    case 'c':
                    case 'C':
                        clearBtn.click();
                        break;
                    // Gé”®ï¼šéšæœºæ¼”å¥
                    case 'g':
                    case 'G':
                        randomBtn.click();
                        break;
                    // æ–¹å‘é”®ï¼šè§¦å‘ä¸åŒåŒºåŸŸéŸ³æ•ˆ
                    case 'ArrowUp':
                        // ä¸ŠåŒºåŸŸ - "å“ˆ"
                        handleCanvasClick(canvas.width / 2, canvas.height / 6);
                        break;
                    case 'ArrowDown':
                        // ä¸‹åŒºåŸŸ - "ç±³"
                        handleCanvasClick(canvas.width / 2, canvas.height * 5 / 6);
                        break;
                    case 'ArrowLeft':
                        // ä¸­åŒºåŸŸå·¦ä¾§ - "åŸº"
                        handleCanvasClick(canvas.width / 3, canvas.height / 2);
                        break;
                    case 'ArrowRight':
                        // ä¸­åŒºåŸŸå³ä¾§ - "åŸº"
                        handleCanvasClick(canvas.width * 2 / 3, canvas.height / 2);
                        break;
                    // æ•°å­—é”®1-3ï¼šç›´æ¥è§¦å‘å¯¹åº”éŸ³æ•ˆ
                    case '1':
                        handleCanvasClick(canvas.width / 2, canvas.height / 6);
                        break;
                    case '2':
                        handleCanvasClick(canvas.width / 2, canvas.height / 2);
                        break;
                    case '3':
                        handleCanvasClick(canvas.width / 2, canvas.height * 5 / 6);
                        break;
                }
            });

            // åˆå§‹æ¼”ç¤º
            setTimeout(() => {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                circles.push(new Circle(centerX, centerY, '#ff6ec7', 'ha'));
                createParticles(centerX, centerY, '#ff6ec7', 20);
                playSound('ha');

                setTimeout(() => {
                    circles.push(new Circle(centerX, centerY + 100, '#7873f5', 'ji'));
                    createParticles(centerX, centerY + 100, '#7873f5', 20);
                    playSound('ji');
                }, 500);

                setTimeout(() => {
                    circles.push(new Circle(centerX, centerY + 200, '#4fc3f7', 'mi'));
                    createParticles(centerX, centerY + 200, '#4fc3f7', 20);
                    playSound('mi');
                }, 1000);
            }, 1500);
        });
    </script>
</body>
</html>