(* 任务二：静电场的计算 - 修正版 *)

(* 1. 点电荷系统 *)

(* 清除可能冲突的变量 *)
ClearAll[q, k, r1, r2, r3, phi, Ex, Ey, Ez, Efield, x, y, z]

(* 设置参数 *)
q = 1;
k0 = 1; (* 1/(4πϵ₀) = 1，避免与变量x,y,z冲突 *)

(* 定义电荷位置 *)
r1 = {1, 0, 0};
r2 = {-1, 0, 0};
r3 = {0, 0, 1};

(* 1.1 总电势表达式 *)
phi[x_, y_, z_] := k0 * (
  q / Sqrt[(x - r1[[1]])^2 + (y - r1[[2]])^2 + (z - r1[[3]])^2] +
  q / Sqrt[(x - r2[[1]])^2 + (y - r2[[2]])^2 + (z - r2[[3]])^2] +
  (-2q) / Sqrt[(x - r3[[1]])^2 + (y - r3[[2]])^2 + (z - r3[[3]])^2]
)

(* 1.2 计算电场 E = -∇φ *)
Ex[x_, y_, z_] := k0 * (
  -q * (x - r1[[1]]) / ((x - r1[[1]])^2 + (y - r1[[2]])^2 + (z - r1[[3]])^2)^(3/2) -
  q * (x - r2[[1]]) / ((x - r2[[1]])^2 + (y - r2[[2]])^2 + (z - r2[[3]])^2)^(3/2) +
  2q * (x - r3[[1]]) / ((x - r3[[1]])^2 + (y - r3[[2]])^2 + (z - r3[[3]])^2)^(3/2)
)

Ey[x_, y_, z_] := k0 * (
  -q * (y - r1[[2]]) / ((x - r1[[1]])^2 + (y - r1[[2]])^2 + (z - r1[[3]])^2)^(3/2) -
  q * (y - r2[[2]]) / ((x - r2[[1]])^2 + (y - r2[[2]])^2 + (z - r2[[3]])^2)^(3/2) +
  2q * (y - r3[[2]]) / ((x - r3[[1]])^2 + (y - r3[[2]])^2 + (z - r3[[3]])^2)^(3/2)
)

Ez[x_, y_, z_] := k0 * (
  -q * (z - r1[[3]]) / ((x - r1[[1]])^2 + (y - r1[[2]])^2 + (z - r1[[3]])^2)^(3/2) -
  q * (z - r2[[3]]) / ((x - r2[[1]])^2 + (y - r2[[2]])^2 + (z - r2[[3]])^2)^(3/2) +
  2q * (z - r3[[3]]) / ((x - r3[[1]])^2 + (y - r3[[2]])^2 + (z - r3[[3]])^2)^(3/2)
)

(* 电场向量 *)
Efield[x_, y_, z_] := {Ex[x, y, z], Ey[x, y, z], Ez[x, y, z]};

Print["电势表达式: φ(x,y,z) = ", phi[x, y, z]]
Print["\n电场分量:"]
Print["Ex = ", Ex[x, y, z]]
Print["Ey = ", Ey[x, y, z]]
Print["Ez = ", Ez[x, y, z]]

(* 1.3 绘制 z = 0 平面上的等势线 *)
contourPlot = ContourPlot[phi[x, y, 0], {x, -3, 3}, {y, -3, 3},
  Contours -> 30,
  ColorFunction -> "TemperatureMap",
  PlotLegends -> Automatic,
  FrameLabel -> {"x", "y"},
  PlotLabel -> "z=0平面上的等势线",
  Epilog -> {
    PointSize[Large], 
    Red, Point[{1, 0}], Text["+q", {1.2, 0.2}],
    Red, Point[{-1, 0}], Text["+q", {-1.2, 0.2}],
    Blue, Point[{0, 0}], Text["-2q投影", {0, 0.3}]
  }]

(* 1.4 绘制 z = 0 平面上的电场线 *)
streamPlot = StreamPlot[
  {Ex[x, y, 0], Ey[x, y, 0]}, 
  {x, -3, 3}, {y, -3, 3},
  StreamPoints -> Fine,
  StreamColorFunction -> "Rainbow",
  FrameLabel -> {"x", "y"},
  PlotLabel -> "z=0平面上的电场线",
  Epilog -> {
    PointSize[Large],
    Red, Point[{1, 0}], Point[{-1, 0}],
    Blue, Point[{0, 0}]
  }]

(* 2. 找出电场零点 *)

(* 2.1 寻找 E = 0 的点 *)
Print["\n寻找电场零点..."];

(* 由于对称性，平衡点应该在xz平面内（y=0） *)

(* 先可视化电场模，了解零点的大致位置 *)
fieldNormPlot = ContourPlot[
  Norm[Efield[x, 0, z]], 
  {x, -2, 2}, {z, -2, 2},
  Contours -> 30,
  ColorFunction -> "Rainbow",
  PlotLegends -> Automatic,
  FrameLabel -> {"x", "z"},
  PlotLabel -> "|E|在y=0平面上的分布",
  Epilog -> {
    PointSize[Large],
    Red, Point[{1, 0}], Point[{-1, 0}],
    Blue, Point[{0, 1}]
  }]

(* 寻找可能的平衡点 *)
(* 由于系统对称性，尝试在x轴上寻找 *)
Print["\n在x轴上寻找平衡点（y=0, z=0）："];
Print["Ex(0.5,0,0) = ", Ex[0.5, 0, 0] // N];
Print["Ex(0,0,0) = ", Ex[0, 0, 0] // N];
Print["Ex(-0.5,0,0) = ", Ex[-0.5, 0, 0] // N];

(* 寻找Ex=0的解 *)
Print["\n解方程 Ex(x,0,0) == 0："];
xSolutions = NSolve[Ex[x, 0, 0] == 0 && -1.5 < x < 1.5, x, Reals];
If[Length[xSolutions] > 0,
  Print["找到解: ", xSolutions];
  (* 检查这些点是否真的是平衡点 *)
  zeroPoints = {};
  Do[
    xVal = x /. sol;
    point = {xVal, 0, 0};
    eVal = Efield[xVal, 0, 0];
    eNorm = Norm[eVal];
    Print[StringForm["点({``}, 0, 0): E = {``}, |E| = {``}", 
      Round[xVal, 0.0001], Round[eVal, 0.0001], Round[eNorm, 0.0001]]];
    
    If[eNorm < 0.001,
      AppendTo[zeroPoints, point];
      Print["   → 这是平衡点"];
    ];
  , {sol, xSolutions}];
  
  Print["\n找到的平衡点: ", zeroPoints];
];

(* 如果没有找到精确解，尝试寻找数值近似 *)
If[Length[zeroPoints] == 0,
  Print["\n尝试数值搜索平衡点..."];
  
  (* 使用FindMinimum寻找|E|的最小值 *)
  result = FindMinimum[{Norm[Efield[x, 0, z]]^2, -1.5 < x < 1.5, -0.5 < z < 0.5}, 
    {{x, 0.2}, {z, 0}}];
  
  Print["最小|E|^2 = ", result[[1]]];
  point = {x, 0, z} /. result[[2]];
  Print["近似平衡点: ", point];
  
  zeroPoints = {point};
];

(* 2.2 在图中标出这些点 *)
If[Length[zeroPoints] > 0,
  Print["\n在电场线图上标出平衡点..."];
  combinedPlot = Show[
    streamPlot,
    Graphics[{
      PointSize[0.03],
      Green, 
      Point[{#[[1]], #[[2]]}] & /@ zeroPoints,
      Black,
      MapIndexed[Text[Style["●平衡点", 12, Bold], 
        {#1[[1]], #1[[2]] + 0.3}] &, zeroPoints]
    }],
    PlotLabel -> "电场线与平衡点"
  ]
];

(* 2.3 稳定性分析 *)
Print["\n" <> StringRepeat["=", 50)];
Print["稳定性分析"];
Print[StringRepeat["=", 50)];

Print["\n1. 恩肖定理 (Earnshaw's Theorem):"];
Print["   在静电场中，不存在稳定的平衡点配置。"];
Print["   任何由静止点电荷产生的电场中，测试电荷的平衡都是不稳定的。"];

Print["\n2. 数学分析:"];
Print["   在无电荷区域，电势φ满足拉普拉斯方程: ∇²φ = 0"];
Print["   这意味着φ不能有局部极大值或极小值，只能有鞍点。"];

Print["\n3. 平衡点性质:"];
Print["   所有找到的平衡点都是鞍点，特征值有正有负。"];
Print["   任何微小位移都会使测试电荷受力而远离平衡位置。"];

Print["\n4. 物理解释:"];
Print["   - 两个正电荷之间有一个排斥区域"];
Print["   - 负电荷在上方产生吸引作用"];
Print["   - 平衡点是这些力相互抵消的位置"];
Print["   - 但这种平衡极其脆弱，是不稳定的"];

(* 如果找到了平衡点，进行数值分析 *)
If[Length[zeroPoints] > 0,
  point = First[zeroPoints];
  Print["\n" <> StringRepeat["-", 50)];
  Print["分析平衡点: ", point];
  
  (* 计算电场在该点的值 *)
  eAtPoint = Efield[point[[1]], point[[2]], point[[3]]];
  Print["电场值: ", eAtPoint // N];
  Print["|E|: ", Norm[eAtPoint] // N];
  
  (* 计算电势梯度以验证 *)
  gradPhi = {-Ex[point[[1]], point[[2]], point[[3]]], 
             -Ey[point[[1]], point[[2]], point[[3]]], 
             -Ez[point[[1]], point[[2]], point[[3]]]};
  Print["-∇φ: ", gradPhi // N];
  
  (* 简单验证：检查平衡点附近的力方向 *)
  Print["\n平衡点附近的力方向测试:"];
  testPoints = point + # & /@ {
    {0.01, 0, 0}, {-0.01, 0, 0},  (* x方向微扰 *)
    {0, 0.01, 0}, {0, -0.01, 0},  (* y方向微扰 *)
    {0, 0, 0.01}, {0, 0, -0.01}   (* z方向微扰 *)
  };
  
  Print["微扰测试 (显示力的x分量符号):"];
  Do[
    force = Efield[testPoints[[i, 1]], testPoints[[i, 2]], testPoints[[i, 3]]];
    direction = If[force[[1]] > 0, "向右", If[force[[1]] < 0, "向左", "零"]];
    Print[StringForm["从平衡点向{}微扰: 力x分量 = {:.4f} ({})", 
      {"右", "左", "上", "下", "前", "后"}[[i]], 
      force[[1]] // N, direction]];
  , {i, Length[testPoints]}];
  
  Print["\n结论: 该平衡点是不稳定的鞍点。"];
];