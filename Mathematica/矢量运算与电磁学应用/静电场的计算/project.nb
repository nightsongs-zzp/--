(* 任务二：静电场的计算 *)

ClearAll["Global`*"]

(* 第一部分：点电荷系统 *)

Print["========================================"]
Print["第一部分：点电荷系统"]
Print["========================================"]

(* 1. 参数设置 *)
q = 1;
k = 1;  (* 1/(4πϵ₀) = 1 *)

(* 电荷位置 *)
pos1 = {1, 0, 0};   (* +q *)
pos2 = {-1, 0, 0};  (* +q *)
pos3 = {0, 0, 1};   (* -2q *)

(* 2. 总电势 φ(x,y,z) 表达式 *)
φ[x_, y_, z_] := k * (
  q / Sqrt[(x - pos1[[1]])^2 + (y - pos1[[2]])^2 + (z - pos1[[3]])^2] +
  q / Sqrt[(x - pos2[[1]])^2 + (y - pos2[[2]])^2 + (z - pos2[[3]])^2] -
  2q / Sqrt[(x - pos3[[1]])^2 + (y - pos3[[2]])^2 + (z - pos3[[3]])^2]
)

Print["总电势表达式:"]
Print["φ(x,y,z) = ", φ[x, y, z]]
Print["物理意义：空间任意点的电势等于三个点电荷在该点产生的电势的代数和"]

(* 3. 计算电场 E = -∇φ *)
Ex[x_, y_, z_] = -D[φ[x, y, z], x] // Simplify;
Ey[x_, y_, z_] = -D[φ[x, y, z], y] // Simplify;
Ez[x_, y_, z_] = -D[φ[x, y, z], z] // Simplify;

Print["\n电场分量:"]
Print["Ex = ", Ex[x, y, z]]
Print["Ey = ", Ey[x, y, z]]
Print["Ez = ", Ez[x, y, z]]

Efield[x_, y_, z_] := {Ex[x, y, z], Ey[x, y, z], Ez[x, y, z]};

(* 4. 绘制图形 *)
Print["\n绘制 z=0 平面上的图形:"]

(* 等势线图 *)
contourPlot = ContourPlot[φ[x, y, 0], {x, -3, 3}, {y, -3, 3},
  Contours -> 30,
  ColorFunction -> "Rainbow",
  PlotLegends -> BarLegend[Automatic, LegendLabel -> "电势 φ"],
  FrameLabel -> {"x", "y"},
  PlotLabel -> "z=0平面上的等势线",
  Epilog -> {
    PointSize[0.03],
    Red, Point[{1, 0}], Text["+q", {1.2, 0.2}],
    Red, Point[{-1, 0}], Text["+q", {-1.2, 0.2}],
    Blue, Point[{0, 0}], Text["-2q投影", {0.2, 0.2}]
  },
  ImageSize -> 400
]

(* 电场线图 *)
streamPlot = StreamPlot[{Ex[x, y, 0], Ey[x, y, 0]}, 
  {x, -3, 3}, {y, -3, 3},
  StreamPoints -> Fine,
  StreamStyle -> Arrowheads[0.02],
  StreamColorFunction -> "BlueGreenYellow",
  FrameLabel -> {"x", "y"},
  PlotLabel -> "z=0平面上的电场线",
  Epilog -> {
    PointSize[0.03],
    Red, Point[{1, 0}], Point[{-1, 0}],
    Blue, Point[{0, 0}]
  },
  ImageSize -> 400
]

(* 显示两个图 *)
GraphicsRow[{contourPlot, streamPlot}, Spacings -> 30]

(* 第二部分：找出电场零点 *)

Print["\n\n========================================"]
Print["第二部分：找出电场零点（平衡点）"]
Print["========================================"]

(* 1. 寻找电场零点 *)
Print["\n寻找电场零点 E=0:"]

(* 在 x 轴上寻找 Ex=0 的点 *)
safeEx[xval_?NumericQ] := 
  If[Abs[xval - 1] > 0.01 && Abs[xval + 1] > 0.01, Ex[xval, 0, 0], 10^6];

initialGuesses = {-0.5, -0.2, 0, 0.2, 0.5};
equilibriumPoints = {};

Do[
  Try[
    root = FindRoot[safeEx[x] == 0, {x, guess}, 
      MaxIterations -> 100, AccuracyGoal -> 8];
    xRoot = x /. root;
    
    (* 计算该点电场 *)
    Eval = Efield[xRoot, 0, 0];
    eNorm = Norm[Eval];
    
    If[eNorm < 0.001,
      point = {xRoot, 0, 0};
      AppendTo[equilibriumPoints, point];
      Print[StringForm["找到平衡点: ({:.4f}, 0, 0)", xRoot]];
    ]
  ],
  {guess, initialGuesses}
];

(* 2. 在图中标出平衡点 *)
Print["\n在图中标出平衡点:"]

If[Length[equilibriumPoints] > 0,
  combinedPlot = Show[
    streamPlot,
    Graphics[{
      PointSize[0.04],
      Green, EdgeForm[Black],
      Point[#[[{1, 2}]] & /@ equilibriumPoints],
      MapIndexed[
        With[{pos = #1[[{1, 2}]] + {0.3, 0.3}},
          {Text[Style["●", 20, Green], pos],
           Text[Style["平衡点", 10, Bold, Background -> White], pos + {0, -0.15}]}
        ] &, equilibriumPoints]
    }],
    PlotLabel -> "电场线与平衡点",
    ImageSize -> 450
  ];
  
  Print["平衡点位置:"];
  Do[
    Print[StringForm["  点{}: ({:.4f}, 0, 0)", 
      i, equilibriumPoints[[i, 1]]]];
  , {i, Length[equilibriumPoints]}];
  
  combinedPlot
,
  Print["未找到明显的电场零点。"];
];

(* 第三部分：稳定性分析 *)

Print["\n\n========================================"]
Print["第三部分：平衡点稳定性分析"]
Print["========================================"]

If[Length[equilibriumPoints] > 0,
  point = First[equilibriumPoints];
  x0 = point[[1]];
  
  Print["\n分析平衡点 P = (", Round[x0, 0.001], ", 0, 0):"];
  
  (* 微扰分析 *)
  eps = 0.001;
  
  Print["\n微扰分析 (位移 0.001):"];
  
  (* x方向微扰 *)
  forceRight = Efield[x0 + eps, 0, 0];
  forceLeft = Efield[x0 - eps, 0, 0];
  
  Print["x+方向: Fx = ", Round[forceRight[[1]], 0.0001]]
  Print["x-方向: Fx = ", Round[forceLeft[[1]], 0.0001]]
  
  (* 判断x方向稳定性 *)
  stableInX = forceRight[[1]] * forceLeft[[1]] < 0;
  Print[StringForm["  x方向: {}恢复力", If[stableInX, "有", "无"]]];
  
  (* y方向微扰 *)
  forceUp = Efield[x0, eps, 0];
  forceDown = Efield[x0, -eps, 0];
  
  Print["\ny+方向: Fy = ", Round[forceUp[[2]], 0.0001]]
  Print["y-方向: Fy = ", Round[forceDown[[2]], 0.0001]]
  
  stableInY = forceUp[[2]] * forceDown[[2]] < 0;
  Print[StringForm["  y方向: {}恢复力", If[stableInY, "有", "无"]]];
  
  (* z方向微扰 *)
  forceZplus = Efield[x0, 0, eps];
  forceZminus = Efield[x0, 0, -eps];
  
  Print["\nz+方向: Fz = ", Round[forceZplus[[3]], 0.0001]]
  Print["z-方向: Fz = ", Round[forceZminus[[3]], 0.0001]]
  
  stableInZ = forceZplus[[3]] * forceZminus[[3]] < 0;
  Print[StringForm["  z方向: {}恢复力", If[stableInZ, "有", "无"]]];
  
  (* 理论分析 *)
  Print["\n理论分析 (基于恩肖定理):"];
  Print["恩肖定理: 在静电场中，不存在稳定的平衡点配置"];
  Print["原因: 在无电荷区域，电势满足拉普拉斯方程 ∇²φ = 0"];
  Print("电势不能有局部极大值或极小值，只能有鞍点");
  
  (* 结论 *)
  Print["\n结论:"];
  stableCount = Boole[stableInX] + Boole[stableInY] + Boole[stableInZ];
  If[stableCount == 3,
    Print["  数值上三个方向都有恢复力，但根据恩肖定理这是不可能的"];
    Print["  可能是数值误差"];
  ,
    Print[StringForm["  该点有 {} 个稳定方向和 {} 个不稳定方向", 
      stableCount, 3 - stableCount]];
    Print["  因此该平衡点是不稳定的（鞍点）"];
  ];
  
  Print["\n物理意义："];
  Print("任何微小扰动都会使测试电荷离开平衡位置");
  Print("静电场无法实现稳定悬浮");
];

Print["\n任务二完成"]